<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Login</title>
    <meta charset="UTF-8">
</head>
<body>
<h2>Login with WebAuthn</h2>

<label for="username">Username:</label>
<input type="text" id="username" name="username" required>
<br><br>


<button onclick="startLogin()">Login</button>
<br>
<button onclick="startLogin(true)">ðŸ”‘ Login with Passkey</button>

<p id="status"></p>

<script>
    async function startLogin(usePasskey = false) {
      const username = usePasskey ? '' : document.getElementById('username').value;

       const res = await fetch('/webauthn/login/start', {
           method: 'POST',
           headers: {'Content-Type': 'application/json'},
           body: username ? JSON.stringify({ username }) : '{}'
       });

       const data = await res.json();
       const options = data.reqData.publicKey;
        const requestId = data.requestId;
       options.challenge = base64urlToBuffer(options.challenge);

       if (options.allowCredentials) {
           options.allowCredentials.forEach(c => {
               c.id = base64urlToBuffer(c.id);
           });
       }

       try {
           const assertion = await navigator.credentials.get({
               publicKey: options
           });

           const assertionJson = {
               id: assertion.id,
               rawId: bufferToBase64url(assertion.rawId),
               type: assertion.type,
               response: {
                   authenticatorData: bufferToBase64url(assertion.response.authenticatorData),
                   clientDataJSON: bufferToBase64url(assertion.response.clientDataJSON),
                   signature: bufferToBase64url(assertion.response.signature),
                   userHandle: assertion.response.userHandle
                       ? bufferToBase64url(assertion.response.userHandle)
                       : null,
               },
               clientExtensionResults: assertion.getClientExtensionResults(),
           };

           const result = await fetch('/webauthn/login/finish', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
<!--               body: JSON.stringify(assertionJson)-->
                 body: JSON.stringify({
                        credential: assertionJson,
                        requestId: requestId,
                    })
           });

           document.getElementById('status').innerText = await result.text();
       } catch (err) {
           document.getElementById('status').innerText = 'Login failed or cancelled.';
           console.error(err);
       }
   }


       function bufferToBase64url(buffer) {
           return btoa(String.fromCharCode(...new Uint8Array(buffer)))
               .replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, "");
       }

       function base64urlToBuffer(baseurl) {
           const padding = '='.repeat((4 - baseurl.length % 4) % 4);
           const base64 = (baseurl + padding).replace(/-/g, '+').replace(/_/g, '/');
           const raw = atob(base64);
           return Uint8Array.from([...raw].map(ch => ch.charCodeAt(0))).buffer;
       }
</script>
</body>
</html>
